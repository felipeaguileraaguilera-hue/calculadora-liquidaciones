<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1f16">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Liquidaciones">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <title>Calculadora de Liquidaciones - Aceites Tapia</title>
  <style>
    :root {
      --bg:#1a1f16;--card:#232a1e;--card-hi:#2a3322;
      --accent:#b8a44c;--accent-dim:#8a7a38;
      --olive:#6b7c3f;--olive-dk:#4a5a2a;
      --text:#e8e4d8;--muted:#9b9680;--dim:#6b6652;
      --border:#3a4230;--danger:#a44c4c;--success:#5a8a3a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Georgia','Palatino','Times New Roman',serif;background:linear-gradient(170deg,var(--bg) 0%,#12160e 50%,#1a1a10 100%);color:var(--text);min-height:100vh;min-height:100dvh;-webkit-font-smoothing:antialiased}
    body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background-image:radial-gradient(ellipse at 20% 80%,rgba(74,90,42,.08) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(184,164,76,.03) 0%,transparent 40%)}
    .container{max-width:480px;margin:0 auto;padding:0 20px;position:relative;z-index:1}
    .header{padding-top:36px;padding-bottom:20px;text-align:center;border-bottom:1px solid var(--border);position:relative}
    .header-brand{font-size:11px;letter-spacing:6px;text-transform:uppercase;color:var(--accent);margin-bottom:6px}
    .header h1{font-size:22px;font-weight:400;line-height:1.3;letter-spacing:1px}
    .header h1.accent{font-size:26px;color:var(--accent);font-style:italic;letter-spacing:.5px}
    .header-sub{font-size:12px;color:var(--muted);margin-top:8px;font-style:italic;letter-spacing:.5px}
    .btn-admin{position:absolute;top:38px;right:0;background:transparent;border:none;color:var(--dim);font-size:20px;cursor:pointer;padding:8px;opacity:.5;transition:opacity .2s;line-height:1}
    .btn-admin:hover,.btn-admin:active{opacity:1}
    .tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:28px}
    .tab-btn{flex:1;padding:16px 0;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--dim);font-size:13px;letter-spacing:1px;cursor:pointer;transition:all .3s;font-family:inherit;text-transform:uppercase}
    .tab-btn.active{border-bottom-color:var(--accent);color:var(--accent)}
    .tab-panel{display:none;padding-bottom:40px}
    .tab-panel.active{display:block;animation:fadeIn .3s ease}
    .field{margin-bottom:22px}
    .field-label{font-size:14px;color:var(--text);display:block;margin-bottom:3px;letter-spacing:.3px}
    .field-sub{font-size:11px;color:var(--dim);display:block;margin-bottom:8px}
    .input-wrap{display:flex;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;transition:border-color .2s}
    .input-wrap:focus-within{border-color:rgba(184,164,76,.5)}
    .input-wrap input{flex:1;padding:14px 16px;background:transparent;border:none;color:var(--text);font-size:18px;font-family:'Georgia',serif;outline:none;width:100%}
    .input-wrap .suffix{padding:14px 16px;color:var(--dim);font-size:13px;white-space:nowrap;border-left:1px solid var(--border);background:rgba(26,31,22,.5);min-width:50px;text-align:center}
    .mini-field{flex:1}
    .mini-field label{font-size:11px;color:var(--muted);display:block;margin-bottom:6px}
    .mini-wrap{display:flex;align-items:center;background:var(--bg);border:1px solid var(--border);border-radius:8px;overflow:hidden}
    .mini-wrap input{flex:1;padding:10px 12px;background:transparent;border:none;color:var(--text);font-size:15px;font-family:monospace;outline:none;width:100%}
    .mini-wrap .suffix{padding:10px;color:var(--dim);font-size:12px;border-left:1px solid var(--border);background:var(--bg)}
    .result-card{margin-top:28px;background:linear-gradient(135deg,var(--card-hi),var(--card));border:1px solid rgba(184,164,76,.25);border-radius:16px;padding:28px;position:relative;overflow:hidden;animation:slideUp .4s ease}
    .result-card::after{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;background:rgba(184,164,76,.03)}
    .result-label-sm{font-size:11px;letter-spacing:4px;text-transform:uppercase;color:var(--muted);margin-bottom:20px}
    .result-sublabel{font-size:13px;color:var(--muted);margin-bottom:6px}
    .result-big{font-size:36px;font-weight:300;letter-spacing:-.5px;line-height:1}
    .result-bigger{font-size:42px;font-weight:300;letter-spacing:-1px;line-height:1}
    .divider{border-top:1px solid var(--border);padding-top:20px;margin-top:20px}
    .config-panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:24px}
    .config-title{font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:16px}
    .config-title.mt{margin-top:20px}
    .range-row{display:flex;gap:12px}
    .table-info{font-size:11px;color:var(--dim);margin-bottom:12px;text-align:center;letter-spacing:.5px}
    .tab-desc{font-size:13px;color:var(--muted);line-height:1.7;margin-bottom:24px}
    .table-wrap{overflow-x:auto;border-radius:12px;border:1px solid var(--border);-webkit-overflow-scrolling:touch}
    .table-wrap::-webkit-scrollbar{height:4px}
    .table-wrap::-webkit-scrollbar-track{background:var(--bg)}
    .table-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
    .data-table{width:100%;border-collapse:collapse;font-size:12px;font-family:monospace}
    .data-table th{padding:10px 8px;text-align:right;color:var(--muted);border-bottom:1px solid var(--border);font-size:11px;font-weight:400;letter-spacing:.5px;white-space:nowrap}
    .data-table th.sticky,.data-table td.sticky{position:sticky;left:0;z-index:1;border-right:1px solid var(--border)}
    .data-table th.sticky{z-index:2;background:var(--card)}
    .data-table td{padding:9px 8px;text-align:right;border-bottom:1px solid rgba(58,66,48,.13)}
    .data-table td.sticky{font-weight:600;color:var(--accent)}
    .data-table tr:nth-child(even) td{background:rgba(26,31,22,.25)}
    .data-table tr:nth-child(even) td.sticky{background:var(--card-hi)}
    .data-table tr:nth-child(odd) td.sticky{background:var(--card)}
    .table-footer{font-size:11px;color:var(--dim);margin-top:14px;text-align:center;font-style:italic;line-height:1.6}
    .modal-overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;padding:20px}
    .modal-overlay.hidden{display:none}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:32px;width:100%;max-width:380px;animation:slideUp .3s ease}
    .modal-title{font-size:11px;letter-spacing:4px;text-transform:uppercase;color:var(--accent);margin-bottom:20px;text-align:center}
    .modal-desc{font-size:13px;color:var(--muted);text-align:center;margin-bottom:24px;line-height:1.6}
    .pin-row{display:flex;gap:10px}
    .pin-input{flex:1;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:18px;text-align:center;letter-spacing:8px;font-family:monospace;outline:none}
    .pin-input.error{border-color:var(--danger)}
    .btn-pin{padding:14px 24px;background:var(--accent);border:none;border-radius:10px;color:var(--bg);font-weight:600;font-size:14px;cursor:pointer}
    .pin-error{color:var(--danger);font-size:12px;text-align:center;margin-top:12px}
    .admin-field{margin-bottom:20px}
    .admin-field label{font-size:13px;color:var(--muted);display:block;margin-bottom:8px}
    .admin-field input{width:100%;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:18px;font-family:monospace;outline:none}
    .admin-field .desc{font-size:11px;color:var(--dim);margin-top:6px}
    .admin-summary{padding:16px;background:var(--bg);border-radius:10px;font-size:12px;color:var(--muted);line-height:1.7;border:1px solid var(--border);margin-bottom:24px;margin-top:4px}
    .admin-summary strong{color:var(--accent)}
    .btn-save{width:100%;padding:14px;background:var(--olive);border:none;border-radius:10px;color:var(--text);font-size:14px;cursor:pointer;letter-spacing:1px;font-family:inherit}
    .btn-cancel{width:100%;padding:10px;margin-top:10px;background:transparent;border:none;color:var(--dim);font-size:12px;cursor:pointer}
    .color-accent{color:var(--accent)}.color-danger{color:var(--danger)}.color-success{color:var(--success)}.color-text{color:var(--text)}
    .spacer{height:40px}
    .hidden{display:none!important}
    input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    input[type="number"]{-moz-appearance:textfield}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    @supports(padding-top:env(safe-area-inset-top)){
      .header{padding-top:calc(36px + env(safe-area-inset-top))}
      .container{padding-left:calc(20px + env(safe-area-inset-left));padding-right:calc(20px + env(safe-area-inset-right))}
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <button class="btn-admin" id="btnAdmin">⚙</button>
      <div class="header-brand">Aceites Tapia</div>
      <h1>Calculadora de</h1>
      <h1 class="accent">Liquidaciones</h1>
      <p class="header-sub">Villanueva de Tapia · desde 1993</p>
    </header>

    <div class="tabs">
      <button class="tab-btn active" id="tabBtn0">Liquidación</button>
      <button class="tab-btn" id="tabBtn1">Tabla de referencia</button>
    </div>

    <!-- TAB 0 -->
    <div class="tab-panel active" id="panel0">
      <div class="field">
        <label class="field-label">Rendimiento bruto</label>
        <span class="field-sub">% grasa de la aceituna</span>
        <div class="input-wrap"><input type="text" inputmode="decimal" id="inRdto" placeholder="ej: 22,50"><span class="suffix">%</span></div>
      </div>
      <div class="field">
        <label class="field-label">Precio del aceite</label>
        <span class="field-sub">€/kg según mercado (PoolRed)</span>
        <div class="input-wrap"><input type="text" inputmode="decimal" id="inPrecio" placeholder="ej: 4,50"><span class="suffix">€/kg</span></div>
      </div>
      <div class="field">
        <label class="field-label">Kilogramos de aceituna</label>
        <span class="field-sub">Cantidad entregada por el proveedor</span>
        <div class="input-wrap"><input type="text" inputmode="decimal" id="inKg" placeholder="ej: 1580"><span class="suffix">kg</span></div>
      </div>
      <div id="resultArea"></div>
    </div>

    <!-- TAB 1 -->
    <div class="tab-panel" id="panel1">
      <p class="tab-desc">Ajusta los rangos de rendimiento y precio del aceite. Los intervalos se mantienen automáticamente.</p>
      <div class="config-panel">
        <div class="config-title">Rendimiento (%)</div>
        <div class="range-row">
          <div class="mini-field"><label>Desde</label><div class="mini-wrap"><input type="text" inputmode="decimal" id="inRdtoMin" value="18"><span class="suffix">%</span></div></div>
          <div class="mini-field"><label>Hasta</label><div class="mini-wrap"><input type="text" inputmode="decimal" id="inRdtoMax" value="25"><span class="suffix">%</span></div></div>
        </div>
        <div class="config-title mt">Precio aceite (€/kg)</div>
        <div class="range-row">
          <div class="mini-field"><label>Desde</label><div class="mini-wrap"><input type="text" inputmode="decimal" id="inPrecioMin" value="4"><span class="suffix">€</span></div></div>
          <div class="mini-field"><label>Hasta</label><div class="mini-wrap"><input type="text" inputmode="decimal" id="inPrecioMax" value="5,5"><span class="suffix">€</span></div></div>
        </div>
      </div>
      <div id="tableInfo" class="table-info"></div>
      <div id="tableArea"></div>
      <p id="tableFooter" class="table-footer"></p>
    </div>
    <div class="spacer"></div>
  </div>

  <!-- ADMIN MODAL -->
  <div class="modal-overlay hidden" id="adminOverlay">
    <div class="modal">
      <div id="adminPin">
        <div class="modal-title">Acceso Administrador</div>
        <p class="modal-desc">Introduce el PIN para acceder a los parámetros internos de la almazara.</p>
        <div class="pin-row">
          <input type="password" inputmode="numeric" maxlength="6" class="pin-input" id="pinField" placeholder="PIN">
          <button class="btn-pin" id="btnPinOk">→</button>
        </div>
        <p class="pin-error hidden" id="pinError">PIN incorrecto</p>
      </div>
      <div id="adminConfig" class="hidden">
        <div class="modal-title">Parámetros internos</div>
        <div class="admin-field"><label>Maquila (€/kg aceituna)</label><input type="number" step="0.01" id="admMaq"><p class="desc">Céntimos cobrados al agricultor por molienda</p></div>
        <div class="admin-field"><label>Descuento rendimiento (%)</label><input type="number" step="0.1" id="admDto"><p class="desc">Porcentaje descontado del rendimiento bruto</p></div>
        <div class="admin-summary" id="admSum"></div>
        <button class="btn-save" id="btnSave">Guardar y cerrar</button>
      </div>
      <button class="btn-cancel" id="btnCancel">Cancelar</button>
    </div>
  </div>

  <script>
    const PIN='1993';
    let maq=parseFloat(localStorage.getItem('at_m'))||0.06;
    let dto=parseFloat(localStorage.getItem('at_d'))||3.5;

    const $=id=>document.getElementById(id);

    // Parse "4,50" or "4.50" → 4.5
    function pn(s){if(!s||s===','||s==='-')return null;const n=parseFloat(s.replace(',','.'));return isNaN(n)?null:n}

    // Clean input: allow digits + one comma, max 2 decimals
    function cd(r){
      let s=r.replace(/[^0-9.,-]/g,'').replace(/\./g,',');
      const p=s.split(',');
      if(p.length>2)s=p[0]+','+p.slice(1).join('');
      if(p.length>=2&&p[p.length-1].length>2)s=p[0]+','+p[1].substring(0,2);
      return s;
    }

    function fe(v,d){d=d||2;if(v===null||isNaN(v))return'—';return v.toLocaleString('es-ES',{minimumFractionDigits:d,maximumFractionDigits:d})+' €'}
    function fd(v){return v.toFixed(2).replace('.',',')}
    function ck(r,p){return(r/100-dto/100)*p-maq}

    // ── TABS ──
    $('tabBtn0').onclick=()=>{$('tabBtn0').classList.add('active');$('tabBtn1').classList.remove('active');$('panel0').classList.add('active');$('panel1').classList.remove('active')};
    $('tabBtn1').onclick=()=>{$('tabBtn1').classList.add('active');$('tabBtn0').classList.remove('active');$('panel1').classList.add('active');$('panel0').classList.remove('active');uT()};

    // ── TAB 0: only update #resultArea ──
    function uR(){
      const r=pn($('inRdto').value),p=pn($('inPrecio').value),k=pn($('inKg').value);
      if(r===null||p===null){$('resultArea').innerHTML='';return}
      const pk=ck(r,p),cp=pk>=0?'color-accent':'color-danger';
      let h='<div class="result-card"><div class="result-label-sm">Resultado</div>';
      h+='<div style="margin-bottom:'+(k!==null?'20px':'0')+'"><div class="result-sublabel">Precio por kg de aceituna</div>';
      h+='<div class="result-big '+cp+'">'+fe(pk,4)+'</div></div>';
      if(k!==null){const l=pk*k,cl=l>=0?'color-text':'color-danger';
        h+='<div class="divider"><div class="result-sublabel">Liquidación total ('+k.toLocaleString('es-ES')+' kg)</div>';
        h+='<div class="result-bigger '+cl+'">'+fe(l)+'</div></div>'}
      h+='</div>';$('resultArea').innerHTML=h;
    }

    // Input handler: clean + keep cursor + update results only
    function hI(inp,cb){
      inp.addEventListener('input',function(){
        const p=this.selectionStart,b=this.value;
        this.value=cd(b);
        const d=this.value.length-b.length;
        this.setSelectionRange(p+d,p+d);
        cb();
      });
    }

    hI($('inRdto'),uR);hI($('inPrecio'),uR);hI($('inKg'),uR);

    // ── TAB 1: only update #tableArea ──
    function uT(){
      const rn=Math.max(0,Math.min(pn($('inRdtoMin').value)||0,100));
      const rx=Math.max(rn+1,Math.min(pn($('inRdtoMax').value)||25,100));
      const pn2=Math.max(0,Math.min(pn($('inPrecioMin').value)||0,999.99));
      const px=Math.max(pn2+.25,Math.min(pn($('inPrecioMax').value)||5.5,999.99));
      const rs=[];for(let i=Math.ceil(rn);i<=Math.floor(rx);i++)rs.push(i);if(!rs.length)rs.push(Math.floor(rn));
      const ps=[];const rg=px-pn2;const st=rg<=2?.25:rg<=4?.5:1;
      for(let i=pn2;i<=px+.001;i+=st)ps.push(Math.round(i*100)/100);if(!ps.length)ps.push(pn2);
      const sd=ps.length>1?fd(ps[1]-ps[0]):'—';
      $('tableInfo').textContent=rs.length+' rendimientos × '+ps.length+' precios · paso rdto: 1% · paso precio: '+sd+'€';
      let h='<div class="table-wrap"><table class="data-table" style="min-width:'+(ps.length*68+60)+'px"><thead><tr><th class="sticky">Rdto.</th>';
      ps.forEach(p=>{h+='<th>'+fd(p)+'€</th>'});h+='</tr></thead><tbody>';
      rs.forEach(r=>{h+='<tr><td class="sticky">'+r+'%</td>';ps.forEach(p=>{const v=ck(r,p);h+='<td class="'+(v<0?'color-danger':v>1?'color-success':'')+'">'+fd(v)+'</td>'});h+='</tr>'});
      h+='</tbody></table></div>';$('tableArea').innerHTML=h;
      $('tableFooter').textContent='Valores en €/kg de aceituna · Maquila: '+fd(maq)+'€ · Dto. rdto: '+String(dto).replace('.',',')+'%';
    }

    hI($('inRdtoMin'),uT);hI($('inRdtoMax'),uT);hI($('inPrecioMin'),uT);hI($('inPrecioMax'),uT);

    // ── ADMIN ──
    function oA(){$('adminOverlay').classList.remove('hidden');$('adminPin').classList.remove('hidden');$('adminConfig').classList.add('hidden');$('pinField').value='';$('pinError').classList.add('hidden');$('pinField').classList.remove('error');setTimeout(()=>$('pinField').focus(),100)}
    function cA(){$('adminOverlay').classList.add('hidden')}
    function cP(){
      if($('pinField').value===PIN){$('adminPin').classList.add('hidden');$('adminConfig').classList.remove('hidden');$('admMaq').value=maq;$('admDto').value=dto;uAS()}
      else{$('pinField').classList.add('error');$('pinError').classList.remove('hidden');$('pinField').value='';setTimeout(()=>$('pinField').focus(),50)}
    }
    function uAS(){const m=parseFloat($('admMaq').value)||0,d=parseFloat($('admDto').value)||0;$('admSum').innerHTML='<strong>Valores actuales:</strong><br>Maquila: '+fd(m)+' €/kg · Descuento: '+String(d).replace('.',',')+' %'}
    function sA(){maq=parseFloat($('admMaq').value)||.06;dto=parseFloat($('admDto').value)||3.5;localStorage.setItem('at_m',maq);localStorage.setItem('at_d',dto);cA();uR();uT()}

    $('btnAdmin').onclick=oA;
    $('btnPinOk').onclick=cP;
    $('pinField').onkeydown=e=>{if(e.key==='Enter')cP()};
    $('pinField').oninput=()=>{$('pinError').classList.add('hidden');$('pinField').classList.remove('error')};
    $('btnSave').onclick=sA;
    $('btnCancel').onclick=cA;
    $('adminOverlay').onclick=e=>{if(e.target===$('adminOverlay'))cA()};
    $('admMaq').oninput=uAS;$('admDto').oninput=uAS;

    // Init
    uT();
    if('serviceWorker'in navigator)window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js').catch(()=>{})});
  </script>
</body>
</html>
