<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1f16">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Liquidaciones">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <title>Calculadora de Liquidaciones - Aceites Tapia</title>
  <style>
    :root {
      --bg: #1a1f16;
      --card: #232a1e;
      --card-hi: #2a3322;
      --accent: #b8a44c;
      --accent-dim: #8a7a38;
      --olive: #6b7c3f;
      --olive-dk: #4a5a2a;
      --text: #e8e4d8;
      --muted: #9b9680;
      --dim: #6b6652;
      --border: #3a4230;
      --danger: #a44c4c;
      --success: #5a8a3a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Georgia', 'Palatino', 'Times New Roman', serif;
      background: linear-gradient(170deg, var(--bg) 0%, #12160e 50%, #1a1a10 100%);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      -webkit-font-smoothing: antialiased;
    }

    /* Ambient background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(ellipse at 20% 80%, rgba(74,90,42,0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 20%, rgba(184,164,76,0.03) 0%, transparent 40%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 0 20px;
      position: relative;
      z-index: 1;
    }

    /* Header */
    .header {
      padding-top: 36px;
      padding-bottom: 20px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .header-brand {
      font-size: 11px;
      letter-spacing: 6px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 400;
      line-height: 1.3;
      letter-spacing: 1px;
    }

    .header h1.accent {
      font-size: 26px;
      color: var(--accent);
      font-style: italic;
      letter-spacing: 0.5px;
    }

    .header-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      font-style: italic;
      letter-spacing: 0.5px;
    }

    .btn-admin {
      position: absolute;
      top: 38px;
      right: 0;
      background: transparent;
      border: none;
      color: var(--dim);
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      opacity: 0.5;
      transition: opacity 0.2s;
      line-height: 1;
    }
    .btn-admin:hover, .btn-admin:active { opacity: 1; }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 28px;
    }

    .tab-btn {
      flex: 1;
      padding: 16px 0;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--dim);
      font-size: 13px;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      text-transform: uppercase;
    }

    .tab-btn.active {
      border-bottom-color: var(--accent);
      color: var(--accent);
    }

    /* Form fields */
    .field { margin-bottom: 22px; }

    .field-label {
      font-size: 14px;
      color: var(--text);
      display: block;
      margin-bottom: 3px;
      letter-spacing: 0.3px;
    }

    .field-sub {
      font-size: 11px;
      color: var(--dim);
      display: block;
      margin-bottom: 8px;
    }

    .input-wrap {
      display: flex;
      align-items: center;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: border-color 0.2s;
    }

    .input-wrap:focus-within {
      border-color: rgba(184, 164, 76, 0.5);
    }

    .input-wrap input {
      flex: 1;
      padding: 14px 16px;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 18px;
      font-family: 'Georgia', serif;
      outline: none;
      width: 100%;
    }

    .input-wrap .suffix {
      padding: 14px 16px;
      color: var(--dim);
      font-size: 13px;
      white-space: nowrap;
      border-left: 1px solid var(--border);
      background: rgba(26, 31, 22, 0.5);
      min-width: 50px;
      text-align: center;
    }

    /* Mini fields (tab 2 ranges) */
    .mini-field { flex: 1; }

    .mini-field label {
      font-size: 11px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    .mini-wrap {
      display: flex;
      align-items: center;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .mini-wrap input {
      flex: 1;
      padding: 10px 12px;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 15px;
      font-family: monospace;
      outline: none;
      width: 100%;
    }

    .mini-wrap .suffix {
      padding: 10px;
      color: var(--dim);
      font-size: 12px;
      border-left: 1px solid var(--border);
      background: var(--bg);
    }

    /* Results card */
    .result-card {
      margin-top: 28px;
      background: linear-gradient(135deg, var(--card-hi), var(--card));
      border: 1px solid rgba(184, 164, 76, 0.25);
      border-radius: 16px;
      padding: 28px;
      position: relative;
      overflow: hidden;
    }

    .result-card::after {
      content: '';
      position: absolute;
      top: -20px;
      right: -20px;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(184, 164, 76, 0.03);
    }

    .result-label-sm {
      font-size: 11px;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 20px;
    }

    .result-sublabel {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .result-big {
      font-size: 36px;
      font-weight: 300;
      letter-spacing: -0.5px;
      line-height: 1;
    }

    .result-bigger {
      font-size: 42px;
      font-weight: 300;
      letter-spacing: -1px;
      line-height: 1;
    }

    .color-accent { color: var(--accent); }
    .color-danger { color: var(--danger); }
    .color-text { color: var(--text); }

    .divider {
      border-top: 1px solid var(--border);
      padding-top: 20px;
      margin-top: 20px;
    }

    /* Tab 2 config panel */
    .config-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .config-title {
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 16px;
    }

    .range-row {
      display: flex;
      gap: 12px;
    }

    .range-row + .config-title { margin-top: 20px; }

    .table-info {
      font-size: 11px;
      color: var(--dim);
      margin-bottom: 12px;
      text-align: center;
      letter-spacing: 0.5px;
    }

    /* Data table */
    .table-wrap {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      -webkit-overflow-scrolling: touch;
    }

    .table-wrap::-webkit-scrollbar { height: 4px; }
    .table-wrap::-webkit-scrollbar-track { background: var(--bg); }
    .table-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      font-family: monospace;
    }

    .data-table th {
      padding: 10px 8px;
      text-align: right;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      font-weight: 400;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .data-table th.sticky,
    .data-table td.sticky {
      position: sticky;
      left: 0;
      z-index: 1;
      border-right: 1px solid var(--border);
    }

    .data-table th.sticky { z-index: 2; background: var(--card); }

    .data-table td {
      padding: 9px 8px;
      text-align: right;
      border-bottom: 1px solid rgba(58, 66, 48, 0.13);
      font-size: 12px;
    }

    .data-table td.sticky { font-weight: 600; color: var(--accent); }

    .data-table tr:nth-child(even) td { background: rgba(26, 31, 22, 0.25); }
    .data-table tr:nth-child(even) td.sticky { background: var(--card-hi); }
    .data-table tr:nth-child(odd) td.sticky { background: var(--card); }

    .table-footer {
      font-size: 11px;
      color: var(--dim);
      margin-top: 14px;
      text-align: center;
      font-style: italic;
      line-height: 1.6;
    }

    /* Tab content */
    .tab-content { padding-bottom: 40px; }

    .tab-desc {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.7;
      margin-bottom: 24px;
    }

    /* Modal overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
      width: 100%;
      max-width: 380px;
      animation: slideUp 0.3s ease;
    }

    .modal-title {
      font-size: 11px;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 20px;
      text-align: center;
    }

    .modal-desc {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .pin-row { display: flex; gap: 10px; }

    .pin-input {
      flex: 1;
      padding: 14px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 18px;
      text-align: center;
      letter-spacing: 8px;
      font-family: monospace;
      outline: none;
    }

    .pin-input.error { border-color: var(--danger); }

    .btn-pin {
      padding: 14px 24px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: var(--bg);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }

    .pin-error {
      color: var(--danger);
      font-size: 12px;
      text-align: center;
      margin-top: 12px;
    }

    .admin-field { margin-bottom: 20px; }

    .admin-field label {
      font-size: 13px;
      color: var(--muted);
      display: block;
      margin-bottom: 8px;
    }

    .admin-field input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 18px;
      font-family: monospace;
      outline: none;
    }

    .admin-field .desc {
      font-size: 11px;
      color: var(--dim);
      margin-top: 6px;
    }

    .admin-summary {
      padding: 16px;
      background: var(--bg);
      border-radius: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.7;
      border: 1px solid var(--border);
      margin-bottom: 24px;
      margin-top: 4px;
    }

    .admin-summary strong { color: var(--accent); }

    .btn-save {
      width: 100%;
      padding: 14px;
      background: var(--olive);
      border: none;
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      letter-spacing: 1px;
      font-family: inherit;
    }

    .btn-cancel {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      background: transparent;
      border: none;
      color: var(--dim);
      font-size: 12px;
      cursor: pointer;
    }

    .spacer { height: 40px; }

    /* Hide number spinners */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

    .fade-in { animation: fadeIn 0.3s ease; }
    .slide-up { animation: slideUp 0.4s ease; }

    /* Safe area for notched phones */
    @supports (padding-top: env(safe-area-inset-top)) {
      .header { padding-top: calc(36px + env(safe-area-inset-top)); }
      .container { padding-left: calc(20px + env(safe-area-inset-left)); padding-right: calc(20px + env(safe-area-inset-right)); }
    }
  </style>
</head>
<body>
  <div class="container" id="app"></div>

  <script>
    // ── State ──
    const state = {
      tab: 0,
      maquila: parseFloat(localStorage.getItem('at_maquila')) || 0.06,
      dtoRdto: parseFloat(localStorage.getItem('at_dto')) || 3.5,
      rdto: '', precio: '', kg: '',
      rdtoMin: '18', rdtoMax: '25', precioMin: '4', precioMax: '5,5',
      showAdmin: false, pin: '', pinErr: false, authed: false,
    };

    // ── Decimal handling ──
    function parseDecimal(str) {
      if (!str || str === '' || str === '-' || str === ',') return null;
      const n = parseFloat(str.replace(',', '.'));
      return isNaN(n) ? null : n;
    }

    function cleanDecimalInput(raw) {
      let s = raw.replace(/[^0-9.,-]/g, '');
      s = s.replace(/\./g, ',');
      const parts = s.split(',');
      if (parts.length > 2) s = parts[0] + ',' + parts.slice(1).join('');
      if (parts.length === 2 && parts[1].length > 2) s = parts[0] + ',' + parts[1].substring(0, 2);
      return s;
    }

    function fmtE(v, d) {
      d = d || 2;
      if (v === null || isNaN(v)) return '—';
      return v.toLocaleString('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }) + ' €';
    }

    function fmtD(v, d) {
      d = d || 2;
      return v.toFixed(d).replace('.', ',');
    }

    // ── Core calc ──
    function calc(r, p) {
      return (r / 100 - state.dtoRdto / 100) * p - state.maquila;
    }

    // ── Save admin params ──
    function saveAdmin() {
      localStorage.setItem('at_maquila', state.maquila);
      localStorage.setItem('at_dto', state.dtoRdto);
    }

    // ── Render ──
    function render() {
      const app = document.getElementById('app');
      let html = '';

      // Header
      html += `
        <header class="header">
          <button class="btn-admin" onclick="openAdmin()" title="Configuración">⚙</button>
          <div class="header-brand">Aceites Tapia</div>
          <h1>Calculadora de</h1>
          <h1 class="accent">Liquidaciones</h1>
          <p class="header-sub">Villanueva de Tapia · desde 1993</p>
        </header>
      `;

      // Tabs
      html += `
        <div class="tabs">
          <button class="tab-btn ${state.tab === 0 ? 'active' : ''}" onclick="setTab(0)">Liquidación</button>
          <button class="tab-btn ${state.tab === 1 ? 'active' : ''}" onclick="setTab(1)">Tabla de referencia</button>
        </div>
      `;

      if (state.tab === 0) {
        html += renderTab0();
      } else {
        html += renderTab1();
      }

      html += '<div class="spacer"></div>';

      if (state.showAdmin) {
        html += renderAdmin();
      }

      app.innerHTML = html;
    }

    function renderTab0() {
      let h = '<div class="tab-content fade-in">';

      h += field('Rendimiento bruto', '% grasa de la aceituna', state.rdto, 'setField("rdto", this.value)', '%', 'ej: 22,50');
      h += field('Precio del aceite', '€/kg según mercado (PoolRed)', state.precio, 'setField("precio", this.value)', '€/kg', 'ej: 4,50');
      h += field('Kilogramos de aceituna', 'Cantidad entregada por el proveedor', state.kg, 'setField("kg", this.value)', 'kg', 'ej: 1.580');

      const rdtoN = parseDecimal(state.rdto);
      const precioN = parseDecimal(state.precio);
      const kgN = parseDecimal(state.kg);

      if (rdtoN !== null && precioN !== null) {
        const precioKg = calc(rdtoN, precioN);
        const colorPk = precioKg >= 0 ? 'color-accent' : 'color-danger';

        h += `<div class="result-card slide-up">
          <div class="result-label-sm">Resultado</div>
          <div style="margin-bottom:${kgN !== null ? '20px' : '0'}">
            <div class="result-sublabel">Precio por kg de aceituna</div>
            <div class="result-big ${colorPk}">${fmtE(precioKg, 4)}</div>
          </div>`;

        if (kgN !== null) {
          const liq = precioKg * kgN;
          const colorLiq = liq >= 0 ? 'color-text' : 'color-danger';
          h += `<div class="divider">
            <div class="result-sublabel">Liquidación total (${kgN.toLocaleString('es-ES')} kg)</div>
            <div class="result-bigger ${colorLiq}">${fmtE(liq)}</div>
          </div>`;
        }

        h += '</div>';
      }

      h += '</div>';
      return h;
    }

    function renderTab1() {
      const rMin = Math.max(0, Math.min(parseDecimal(state.rdtoMin) || 0, 100));
      const rMax = Math.max(rMin + 1, Math.min(parseDecimal(state.rdtoMax) || 25, 100));
      const pMin = Math.max(0, Math.min(parseDecimal(state.precioMin) || 0, 999.99));
      const pMax = Math.max(pMin + 0.25, Math.min(parseDecimal(state.precioMax) || 5.5, 999.99));

      const rdtos = [];
      for (let r = Math.ceil(rMin); r <= Math.floor(rMax); r++) rdtos.push(r);
      if (rdtos.length === 0) rdtos.push(Math.floor(rMin));

      const precios = [];
      const range = pMax - pMin;
      const step = range <= 2 ? 0.25 : range <= 4 ? 0.5 : 1;
      for (let p = pMin; p <= pMax + 0.001; p += step) precios.push(Math.round(p * 100) / 100);
      if (precios.length === 0) precios.push(pMin);

      let h = '<div class="tab-content fade-in">';
      h += '<p class="tab-desc">Ajusta los rangos de rendimiento y precio del aceite. Los intervalos se mantienen automáticamente.</p>';

      // Config
      h += '<div class="config-panel">';
      h += '<div class="config-title">Rendimiento (%)</div>';
      h += '<div class="range-row">';
      h += miniField('Desde', state.rdtoMin, 'setField("rdtoMin", this.value)', '%');
      h += miniField('Hasta', state.rdtoMax, 'setField("rdtoMax", this.value)', '%');
      h += '</div>';
      h += '<div class="config-title" style="margin-top:20px">Precio aceite (€/kg)</div>';
      h += '<div class="range-row">';
      h += miniField('Desde', state.precioMin, 'setField("precioMin", this.value)', '€');
      h += miniField('Hasta', state.precioMax, 'setField("precioMax", this.value)', '€');
      h += '</div>';
      h += '</div>';

      // Info
      const stepDisplay = precios.length > 1 ? fmtD(precios[1] - precios[0]) : '—';
      h += `<div class="table-info">${rdtos.length} rendimientos × ${precios.length} precios · paso rdto: 1% · paso precio: ${stepDisplay}€</div>`;

      // Table
      const minW = precios.length * 68 + 60;
      h += '<div class="table-wrap">';
      h += `<table class="data-table" style="min-width:${minW}px">`;
      h += '<thead><tr><th class="sticky">Rdto.</th>';
      precios.forEach(p => { h += `<th>${fmtD(p)}€</th>`; });
      h += '</tr></thead><tbody>';

      rdtos.forEach(r => {
        h += '<tr>';
        h += `<td class="sticky">${r}%</td>`;
        precios.forEach(p => {
          const v = calc(r, p);
          const cls = v < 0 ? 'color-danger' : v > 1 ? 'color-success' : '';
          h += `<td class="${cls}">${fmtD(v)}</td>`;
        });
        h += '</tr>';
      });

      h += '</tbody></table></div>';
      h += `<p class="table-footer">Valores en €/kg de aceituna · Maquila: ${fmtD(state.maquila)}€ · Dto. rdto: ${String(state.dtoRdto).replace('.', ',')}%</p>`;
      h += '</div>';
      return h;
    }

    function renderAdmin() {
      let h = '<div class="modal-overlay" onclick="if(event.target===this)closeAdmin()">';
      h += '<div class="modal">';

      if (!state.authed) {
        h += `
          <div class="modal-title">Acceso Administrador</div>
          <p class="modal-desc">Introduce el PIN para acceder a los parámetros internos de la almazara.</p>
          <div class="pin-row">
            <input type="password" inputmode="numeric" maxlength="6"
              class="pin-input ${state.pinErr ? 'error' : ''}"
              value="${state.pin}"
              oninput="state.pin=this.value;state.pinErr=false;"
              onkeydown="if(event.key==='Enter')checkPin()"
              placeholder="PIN" id="pinField">
            <button class="btn-pin" onclick="checkPin()">→</button>
          </div>
          ${state.pinErr ? '<p class="pin-error">PIN incorrecto</p>' : ''}
        `;
      } else {
        h += `
          <div class="modal-title">Parámetros internos</div>
          <div class="admin-field">
            <label>Maquila (€/kg aceituna)</label>
            <input type="number" step="0.01" value="${state.maquila}"
              oninput="state.maquila=parseFloat(this.value)||0">
            <p class="desc">Céntimos cobrados al agricultor por molienda</p>
          </div>
          <div class="admin-field">
            <label>Descuento rendimiento (%)</label>
            <input type="number" step="0.1" value="${state.dtoRdto}"
              oninput="state.dtoRdto=parseFloat(this.value)||0">
            <p class="desc">Porcentaje descontado del rendimiento bruto</p>
          </div>
          <div class="admin-summary">
            <strong>Valores actuales:</strong><br>
            Maquila: ${fmtD(state.maquila)} €/kg · Descuento: ${String(state.dtoRdto).replace('.', ',')}%
          </div>
          <button class="btn-save" onclick="saveAndClose()">Guardar y cerrar</button>
        `;
      }

      h += '<button class="btn-cancel" onclick="closeAdmin()">Cancelar</button>';
      h += '</div></div>';
      return h;
    }

    // ── Field builders ──
    function field(label, sub, value, oninput, suffix, placeholder) {
      return `<div class="field">
        <label class="field-label">${label}</label>
        ${sub ? `<span class="field-sub">${sub}</span>` : ''}
        <div class="input-wrap">
          <input type="text" inputmode="decimal" value="${value}" oninput='${oninput}' placeholder="${placeholder}">
          <span class="suffix">${suffix}</span>
        </div>
      </div>`;
    }

    function miniField(label, value, oninput, suffix) {
      return `<div class="mini-field">
        <label>${label}</label>
        <div class="mini-wrap">
          <input type="text" inputmode="decimal" value="${value}" oninput='${oninput}'>
          <span class="suffix">${suffix}</span>
        </div>
      </div>`;
    }

    // ── Actions ──
    function setTab(n) { state.tab = n; render(); }

    function setField(key, raw) {
      state[key] = cleanDecimalInput(raw);
      render();
      // Restore cursor focus
      setTimeout(() => {
        const inputs = document.querySelectorAll('input[type="text"]');
        inputs.forEach(inp => {
          if (inp.value === state[key]) {
            inp.focus();
            inp.setSelectionRange(inp.value.length, inp.value.length);
          }
        });
      }, 0);
    }

    function openAdmin() { state.showAdmin = true; state.pin = ''; state.pinErr = false; state.authed = false; render(); setTimeout(() => { const f = document.getElementById('pinField'); if (f) f.focus(); }, 100); }

    function closeAdmin() { state.showAdmin = false; state.authed = false; state.pin = ''; state.pinErr = false; render(); }

    function checkPin() {
      if (state.pin === '${ADMIN_PIN}') {
        state.authed = true;
        state.pinErr = false;
      } else {
        state.pinErr = true;
        state.pin = '';
      }
      render();
    }

    // Make PIN available (replaced in the template)
    const ADMIN_PIN = '1993';

    // Fix checkPin to use the constant
    function checkPin() {
      if (state.pin === ADMIN_PIN) {
        state.authed = true;
        state.pinErr = false;
      } else {
        state.pinErr = true;
        state.pin = '';
      }
      render();
      if (state.pinErr) {
        setTimeout(() => { const f = document.getElementById('pinField'); if (f) f.focus(); }, 50);
      }
    }

    function saveAndClose() {
      saveAdmin();
      closeAdmin();
    }

    // ── Init ──
    render();

    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registered:', reg.scope))
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
